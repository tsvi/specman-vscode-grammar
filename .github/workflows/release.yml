name: Release

on:
  workflow_dispatch:
    inputs:
      prerelease:
        description: Publish as a VS Code pre-release
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      mode: ${{ steps.check.outputs.mode }}
      version: ${{ steps.check.outputs.version }}
      tag: ${{ steps.check.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine release mode
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=$(jq -r '.version' package.json)
          TAG="v$VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            if [ "${{ inputs.prerelease }}" == "true" ]; then
              echo "Tag $TAG already exists. Skipping."
              echo "mode=skip" >> "$GITHUB_OUTPUT"
            else
              # Check if the existing release is a pre-release that can be promoted
              IS_PRE=$(gh release view "$TAG" --json isPrerelease -q '.isPrerelease' 2>/dev/null || echo "false")
              if [ "$IS_PRE" == "true" ]; then
                echo "Tag $TAG exists as pre-release. Will promote to stable."
                echo "mode=promote" >> "$GITHUB_OUTPUT"
              else
                echo "Tag $TAG already released as stable. Skipping."
                echo "mode=skip" >> "$GITHUB_OUTPUT"
              fi
            fi
          else
            echo "mode=release" >> "$GITHUB_OUTPUT"
          fi

  release:
    needs: check-version
    if: needs.check-version.outputs.mode != 'skip'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-version.outputs.mode == 'promote' && needs.check-version.outputs.tag || '' }}
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          npm install
          pip install jinja-cli
          npm install -g @vscode/vsce

      - name: Package extension
        run: npm run package

      - name: Create tag
        if: needs.check-version.outputs.mode == 'release'
        run: |
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git tag ${{ needs.check-version.outputs.tag }}
          git push origin ${{ needs.check-version.outputs.tag }}

      - name: Create GitHub Release
        if: needs.check-version.outputs.mode == 'release'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PRERELEASE_FLAG=""
          if [ "${{ inputs.prerelease }}" == "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi
          gh release create "${{ needs.check-version.outputs.tag }}" \
            "specman-${{ needs.check-version.outputs.version }}.vsix" \
            --title "Release ${{ needs.check-version.outputs.tag }}" \
            --generate-notes \
            $PRERELEASE_FLAG

      - name: Promote GitHub Release to stable
        if: needs.check-version.outputs.mode == 'promote'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release edit "${{ needs.check-version.outputs.tag }}" \
            --prerelease=false \
            --latest
          gh release upload "${{ needs.check-version.outputs.tag }}" \
            "specman-${{ needs.check-version.outputs.version }}.vsix" \
            --clobber

      - name: Publish to VS Code Marketplace
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          PRERELEASE_FLAG=""
          if [ "${{ inputs.prerelease }}" == "true" ]; then
            PRERELEASE_FLAG="--pre-release"
          fi
          vsce publish --packagePath "specman-${{ needs.check-version.outputs.version }}.vsix" $PRERELEASE_FLAG
